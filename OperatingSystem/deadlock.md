## 교착상태(deadlock)

- 일어나지 않을 사건을 기다리며 진행이 멈춰버리는 현상
- 일련의 프로세스나 스레드들이 서로가 가진 자원을 기다리며 blocked된 상태

## 교착 상태 발생 조건
1. 상호 배제(Mutual exclusion)
    - 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없는 상태
2. 비선점
    - 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못하는 상태
3. 점유와 대기
    - 자원을 할당 받은 상태에서 다른 자원을 할당 받기를 기다리는 상태
4. 순환 대기
    - 프로세스들이 원의 형태로 자원을 대기하는 상태

## 교착상태 해결 방법

- 예방(Deadlock Prevention)
    - 교착 상태가 발생하지 않도록 하는 것
    - 자원 할당 시 교착상태의 4가지 발생 조건(상호 배제, 비선점, 점유와 대기, 순환 대기) 중 어느 하나가 만족되지 않도록 하는 것
- 회피(Deadlock Avoidance)
    - 자원 요청에 대한 부가적인 정보를 이용해서 deadlock의 가능성이 없는 경우에만 자원을 할당
    - 시스템 state가 원래 state로 돌아올 수 있는 경우에만 자원 할당
- 검출 후 회복(Deadlock Detection and recovery)
    - Deadlock 발생은 허용하되 그에 대한 detection 루틴을 두어 deadlock 발견 시 recover
- 교착 상태 무시(Deadlock Ignorance)
    - Deadlock을 시스템이 책임지지 않음
    - Unix를 포함한 대부분의 OS가 채택

## 예방(Deadlock Prevention)
- 상호배제(Mutual Exclusion)
    - 공유해서는 안되는 자원의 경우 반드시 성립해야 함 → 모든 걸 hold하고 시작
- 점유와 대기(Hold and Wait)
    - 특정 프로세스에 자원을 모두 할당하거나, 아예 할당하지 않는 방식으로 배분    
    → 자원의 활용률을 낮출 수 있는 방식
    - 방법 1.  프로세스 시작 시 모든 필요한 자원을 할당 받게 하는 방법 - 이미 hold한 자원도 뱉어놓고 시작 preemption
    - 방법 2. 자원이 필요할 경우 보유 자원을 모두 놓고 다시 요청
- 비선점(No Preemption)
    - 선점이 가능한 자원(e.g. CPU)에 한해 효과적
    → 모든 자원이 선점 가능한 것은 아니다. (e.g. 프린터)
    - 프로세스가 어떤 자원을 기다려야 하는 경우 이미 보유한 자원이 선점됨
    - 모든 필요한 자원을 얻을 수 있을 때 그 프로세스는 다시 시작된다.
    - State를 쉽게 save하고 restore할 수 있는 자원에서 주로 사용(CPU, memory)
- 순환 대기(Circular Wait)
    - 모든 자원 유형에 할당 순서를 정하여 정해진 순서대로만 자원 할당
    - 자원에 번호를 붙이고 오름차순으로 할당하면 원행 대기는 발생하지 않는다.
        - 예를 들어 순서가 3인 자원 Ri를 보유 중인 프로세스가 순서가 1인 자원 Ri을 할당받기 위해서는 우선 Ri를 release해야 한다.
    → Utilization(자원의 이용률) 저하, throughout 감소,  starvation 문제
    → 자원에 번호를 붙이는 것은 어려운 작업
    → 어떤 자원에 어떤 번호를 붙이느냐에 따라 활용률이 달라진다.

## 회피(Deadlock Avoidance)
- 교착 상태를 무분별한 자원 할당으로 인해 발생했다고 간주
- 교착 상태가 발생하지 않을 만큼 할당
    - 자원 요청에 대한 부가정보를 이용해서 자원 할당이 교착상태로부터 안전(safe)한지를 동적으로 조사해서 안전한 경우에만 할당
    - 가장 단순하고 일반적인 모델은 프로세스들이 필요로 하는 자원별 최대 사용량을 미리 선언하도록 하는 방법임
- 배분할 수 있는 자원의 양을 고려하여 교착 상태가 발생하지 않을 만큼만 자원 배분

→ **교착 상태 회피**
- 시스템이 불안전 상태에 들어가지 않는 것을 보장
- 안전 상태에서 안전 상태로 움직이느 경우에만 자원을 할당하는 방식
- 항시 안전 상태를 유지하도록 자원을 할당하는 방식