# 애플리케이션 컨텍스트 : 싱글톤 레지스트리
* 애플리케이션 컨텍스트는 싱글톤을 저장하고 관리
* 스프링은 기본적으로 별다른 설정을 하지 않으면 내부에서 생성하는 빈 오브젝트를 모두 싱글톤으로 만든다.

클아이언트에서 요청이 올 때마다 각 로직을 담당하는 오브젝트를 새로 만들어서 사용하면, 무수히 많은 객체가 생성되고 GC의 성능이 좋아졌다고 한들 서버에 부하가 걸려 감당하기 힘들다.

서블릿은 자바 엔터프라이즈 기술의 가장 기본이 되는 서비스 오브젝트이다. 서블릿은 멀티스레드 환경에서 싱글톤으로 동작한다. 서블릿 클래스당 하나의 오브젝트만 만들어두고, 사용자의 요청을 담당하는 여러 스레드에서 하나의 오브젝트를 공유해 동시에 사용한다.

## 자바 싱글톤 패턴의 문제점
* private 생성자를 갖고 있기 때문에 상속할 수 없다.
* 싱글톤은 테스트하기 힘들다.
* 서버 환경에서 싱글톤이 하나만 만들어지는 것을 보장하지 못한다.
    * 여러 개의 JVM에 분산되서 설치가 되는 경우 각각 독립적으로 오브젝트가 생긴다.
* 싱글톤의 사용은 전역 상태를 만들 수 있기에 바람직하지 못하다.

## 싱글톤 레지스트리
* 스프링은 직접 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 제공하는데 그것이 바로 싱글톤 레지스트리(Singleton Registry)이다. 
* 스프링 컨테이너는 싱글톤을 생성하고, 공급하고 관리하는 싱글톤 관리 컨테이너이기도 하다.

[장점]

* 평범한 자바 클래스를 싱글톤으로 활용하게 해준다.
    * 평범한 자바 클래스라도 IoC 방식의 컨테이너를 사용해서 생성, 관계설정, 사용 등에 대한 제어권을 컨테이너에게 넘기면 손쉽게 싱글톤 방식으로 만들어져 관리되게 할 수 있다.
    * 오브젝트 생성 권한이 모두 애플리케이션 컨텍스트에 있기 때문에 가능하다.
* 테스트에서 싱글톤 방식으로 사용될 클래스를 활용할 수 있다.
    * 테스트 환경에 따라 자유롭게 오브젝트를 만들거나, 목 오브젝트로 대체하는 것도 간단하다. 또한 당연히 이제는 생성자 파라미터를 통해 구현체를 주입하는 것에도 정상적으로 작동한다.
## 스프링 싱글톤 주의점
* 싱글톤이 멀티스레드 환경에서 서비스 형태의 오브젝트로 사용되는 경우에는 상태 정보를 내부에 갖고 있지 않은 무상태(stateless) 방식으로 만들어져야 한다.
* 공유되는 상태 정보를 가지면 여러 사용자들에 의해 내가 해당 값이 바뀌고 읽어져 동시성 문제가 발생 할 확률이 크다.
    * 읽기 전용 값을 상태로 가지는 것은 문제가 없다.
    * 자신아 사용하는 다른 싱글톤 빈을 저장하려는 용도라면 인스턴스 변수를 사용해도 무관하다.
* 단, 파라미터, 로컬 변수, 리턴 값 등의 이용은 자유롭다. 요청 정보, DB 서버 리소스로부터 얻은 정보 등은 자유롭게 사용할 수 있는 파라미터, 로컬 변수, 리턴 값 등을 이용해 처리하면 된다.
```java
public class UserDao {
    private ConnectionMaker connectionMaker; //초기에 설정하면 사용 중에는 바뀌지 않는 읽기전용 인스턴스 변수
    private Connection c;//매번 새로운 값으로 바뀌는 정보를 담은 인스턴스 변수, 심각한 문제 발생
    private User user;//매번 새로운 값으로 바뀌는 정보를 담은 인스턴스 변수, 심각한 문제 발생
    public User get(String id) throws ClassNotFoundException, SQLException {
        //소스 코드 
    }
}
```

## 스프링 빈의 스코프
스프링이 관리하는 오브젝트인 빈이 생성되고 존재하고 적용되는 범위를 빈의 스코프라고 한다.
* 스프링 빈의 기본 스코프는 싱글톤이며, 이는 스프링 컨테이너가 존재하는 동안에는 계속 유지된다.
* 그러나 경우에 따라서는 싱글톤 외에 다른 스코프를 가질 수도 있다.
    * 프로토타입 스코프의 경우, 싱글톤과 달리 컨테이너에 빈을 요청할 때마다 매번 새로운 오브젝트를 만들어준다.
    * HTTP 요청이 생길 때마다 생성되는 요청 스코프
    * 웹의 세션과 유사한 스코프를 가지는 세션 스코프
