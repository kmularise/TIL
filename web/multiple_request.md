# 동시 요청 - 멀티 스레드

## 요청 마다 스레드 생성
![image](https://github.com/kmularise/TIL/assets/106499310/8ea4f351-b829-4f4f-9af7-08c5c373c788)

[장단점]
* 장점
    1. 동시 요청을 처리할 수 있다.
    2. 리소스(CPU, 메모리)가 허용할 때까지 처리 가능
    3. 하나의 스레드가 지연되어도, 나머지 스레드는 정상 동작한다.
* 단점
    1. 스레드는 생성 비용이 높다.
        * 고객의 요청이 올 때 마다 스레드가 생성하면, 응답 속도가 늦어진다.
    2. 스레드는 컨텍스트 스위칭 비용이 발생한다.
    3. 스레드 생성에 제한이 없다.
        * 고객 요청이 너무 많이 오면, CPU, 메모리, 임게점을 넘어서 서버가 죽을 수 있다.

## 스레드 풀
![image](https://github.com/kmularise/TIL/assets/106499310/2f8a272d-0525-46c8-8543-3563ce3ebea3)

요청 마다 스레드 생성의 단점 보완
* 특징
    * 필요한 스레드를 스레드 풀에 보관하고 관리한다.
    * 스레드 풀에 생성 가능한 스레드 최대치를 관리한다. 톰캣은 최대 200개가 기본 설정이다.(변경 가능)
* 사용
    * 스레드가 필요하면, 이미 생성되어 있는 스레드를 스레드 풀에서 꺼내서 사용한다.
    * 사용을 종료하면 스레드 풀에 해당 스레드를 반납한다.
    * 최대 스레드가 모두 사용 중이어서 스레드 풀에 스레드가 없으면?
        * 기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정할 수 있다.
* 장점
    * 스레드가 미리 생성되어 있으므로, 스레드를 생성하고 종료하는 비용이 절약되고, 응답 시간이 빠르다.
    * 생성 가능한 스레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청을 안전하게 처리할 수 있다.

### 성능 튜닝
* WAS의 주요 튜닝 포인트는 최대 스레드(max thread) 수이다.
* 최대 스레드 수를 너무 낮게 설정하면 동시 요청이 많을 때, 서버 리소스는 여유롭지만, 클라이언트는 금방 응답 지연 상태가 된다.
* 최대 스레드 수를 너무 높게 설정하면 CPU, 메모리 리소스 임계점 초과로 서버가 다운된다.
* 장애 발생 시
    * 클라우드 서버이면 일단 서버부터 늘리고, 이후에 튜닝
    * 온프레미스 서버면 일단 열심히 튜닝..

### 스레드 풀의 적정 숫자
* 애플리케이션 로직의 복잡도, CPU, 메모리, I/O 리소스 상황에 따라 다르다.
* 성능 테스트 
    * 실제 서비스와 유사하게 성능 테스트 시도
    * 툴 : 아파치 ab, 제이미터, **nGrinder**

## WAS의 멀티 스레드
* 멀티 스레드에 대한 부분 : WAS가 처리
* **개발자가 멀티 스레드 관련 코드를 신경 쓰지 않아도 된다.**
* 개발자는 마치 **싱글 스레드 프로그래밍을 하듯이 편리하게 소스 코드를 개발**
* 멀티 스레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 공유 변수 관련해서 주의해서 사용

