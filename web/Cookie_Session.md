# 쿠키와 세션
_____________
# 쿠키
* HTTP의 무상태성을 보완
* 쿠키(cookie)는 웹 브라우저가 보관하는 데이터이다. 
* 웹 브라우저는 웹 서버에 요청을 보낼 때 쿠키를 함게 전송하며, 웹 서버는 웹 브라우저가 전송한 쿠키를 사용해서 필요한 데이터를 읽을 수 있다.
* 쿠키는 웹 서버와 웹 브라우저 양쪽에서 생성할 수 있다.
* JSP에서 생성하는 쿠키는 웹 서버에서 생성하는 쿠키이다.

## 쿠키의 종류 : 세션 쿠키 VS 영속 쿠키
<img width="605" alt="image" src="https://github.com/uotoua/TIL/assets/106499310/6c214461-4ec5-4ecc-bb73-0f6c1f1ac684">

> Expires / Max-Age에 날짜 및 시간이 있으면 영속 쿠키, Session 값이 있으면 세션 쿠키

* 세션 쿠키(Session Cookie):
	* 만료 날짜를 생략하면 브라우저 종료시 까지만 유지
	* 메모리에 저장
	* 일반적으로 사용자가 사이트 탐색 시에 관련한 설정 및 선호사항 저장
* 영속 쿠키(Persistent Cookie, 지속 쿠키):
	* 만료 날짜를 입력하면 해당 날짜까지 유지
	* 디스크에 저장
	* 일반적으로 사용자 로그인 유지에 사용

## 쿠키 동작 방식 (웹 서버 생성 기준)
![image](https://github.com/kmularise/TIL/assets/106499310/87839b20-7899-41f2-a368-60b793a35b09)


웹 서버가 클라이언트로 보내는 응답의 헤더 중 Set-Cookie라는 헤더에 키와 값을 함께 실어 보내면 그 응답을 받은 브라우저는 해당 쿠키를 저장하고, 그 다음 요청부터 자동으로 쿠키를 Cookie 헤더에 넣어 송신한다.
1. 쿠키 생성 단계 : 쿠키를 웹 서버 측에서 생성하고 생성한 쿠키를 응답 데이터의 헤더에 저장해서 웹 브라우저에 전송한다.
2. 쿠키 저장 단계 : 웹 브라우저는 응답 데이터에 포함된 쿠키를 쿠키 저장소에 보관한다. 쿠키의 종류에 따라 메모리나 파일에 저장한다.
3. 쿠키 전송 단계 : 웹 브라우저는 저장한 쿠키를 요청이 있을 때마다 웹 서버에 전송한다. 웹 서버는 웹 브라우저가 전송한 쿠키를 사용해서 필요한 작업을 수행한다.

웹 브라우저에 쿠키가 저장되면, 웹 브라우저는 쿠기가 삭제되기 전까진 웹 서버에 쿠키를 전송한다. 웹 어플리케이션을 사용하는 동안 지속적으로 유지해야 하는 정보는 쿠키를 사용해서 저장하면 된다.

## 쿠키의 문제점
* 쿠키에 저장된 정보가 많다면, 매 요청마다 오버헤드가 발생한다.
	* 이러한 이유로 일반적으로 쿠키의 데이터는 4kb로 제한이 되어있다. 또한 쿠키의 개수도 제한하는 경우가 있다.
* 보안 이슈 존재
	* 쿠키의 값은 쉽게 수정이 가능하다. 악의적인 해커에 의해 변조될 가능성이 크다.
		1. XSS(크로스 사이트 스크립트) 공격 : 서버 측에서 제공되는 Script가 아닌 권한이 없는 사용자(해커)가 웹사이트에 Script를 삽입하여 의도치 않은 동작을 일으키는 공격 -> 해결 : HttpOnly 속성을 통해 JavaScript로 Cookie에 접근하지 못하게 한다.
		2. 스니핑 공격 : 스니핑은 말그대로 도청의 기법으로, 네트워크 상에서 권한이 없는 사용자가 다른 상대방들의 패킷 교환을 엿듣는 것 -> 해결 : SSL 통신(인증서 확인)
		3. 영속 쿠키의 쿠키값 유출 : 영속 쿠키는 하드디스크에 저장되며, 간단한 방법으로 접근 가능하기 때문에 사용자 정보가 유출될 수 있다.

## 쿠키 구성
| 구성요소 | 설명 | 특이점 |
| ------- | ----- | ---- |
| 이름 | 각각의 쿠키를 구별하는데 사용되는 이름 | - |
| 값 | 쿠키의 이름과 관련된 값 | - |
| 유효시간 | 쿠키의 유지 시간 | 별도의 유효시간을 지정하지 않으면 웹 브라우저 종료 시 쿠키 함께 삭제, 쿠키를 삭제하려면 0으로 설정 |
| 도메인 | 쿠키를 전송할 도메인 | 같은 도메인을 사용하는 모든 서버에 쿠키를 보내야 할 때가 있을 때는 쿠키를 전송할 수 있는 도메인을 지정해야 한다. |
| 경로 | 쿠키를 전송할 요청 경로 | 경로를 지정할 경우 지정한 경로 또는 하위 경로에 대해서만 쿠키를 전송한다. 쿠키에 경로를 지정하지 않으면 실행한 URL의 경로 부분을 사용한다. 일반적으로 쿠키는 웹 애플리케이션에 포함된 다수의 JSP와 서블릿에서 사용하기 때문에 쿠키 경로를 '/'으로 지정한다. |

### 쿠키의 도메인
* 기본적으로 쿠키는 그 쿠키를 생성한 서버에만 전송된다.
* 같은 도메인을 사용하는 모든 서버에 쿠키를 보내야 할 때가 있을 때는 쿠키를 전송할 수 있는 도메인을 지정해야 한다.
* 웹 브라우저가 타 도메인으로 지정한 쿠키를 받지 않는다.
	* 그 이유는 보안 문제 때문이다. 다른 도메인 서버에서 보안 정책이 적용되어 있는 현재 도메인 서버의 쿠키의 값을 마음대로 변경할 수 있다면 애플리케이션의 보안은 뚤히게 된다. 이런 이유로 웹 브라우저는 현재 서버의 도메인과 다른 도메인에 대한 쿠키 생성은 허용하지 않는다.


### 쿠키와 헤더
* 쿠키를 추가하면 Set-Cookie 헤더를 통해서 전달된다.
* 한개의 Set-Cookie 헤더는 한 개의 쿠키 값을 전달한다.

## 쿠키와 로그인
* 로그인 성공을 나타내는 쿠키를 생성한 이후, 웹 브라우저는 요청을 보낼 때마다 쿠키를 전송한다.
* 로그인에 성공할 때 생성되는 쿠키의 값을 확인하면 현재 로그인했는지 여부를 판단할 수 있다.
* 웹 브라우저의 자체적인 개발도구를 사용하면 쿠키 값을 변경해서 쿠키를 서버에 전송할 수 있다.
* 이러한 이유로 쿠키에 값을 저장할 때 다양한 암호화 방식을 혼합해서 저장한다. (ex. JWT 토큰, access token과 refresh token) 
_______________________
# 세션
* 서버 측에 정보를 저장하는 방식
* 세션을 사용하면 클라이언트의 상태를 저장할 수 있다.
* 웹 브라우저로 웹서버에 접속한 시점부터 웹 브라우저를 종료하여 연결을 끝내는 시점까지 일련의 요청을 하나의 상태로 간주하고, 그 상태를 일정하게 유지하는 기술
* 서버에 값을 저장한다.
* 로그인한 사용자 정보를 유지하기 위한 목적으로 세션 사용

## 세션 생성과 사용
![image](https://github.com/kmularise/TIL/assets/106499310/1310b83d-4503-41e5-b0f1-d0890feaeae9)

* 웹 컨테이너는 기본적으로 한 웹 브라우저마다 한 세션을 생성한다.
* 같은 JSP 페이지라도 웹 브라우저에 따라 서로 다른 세션 사용
* 세션을 사용하는 서버 프로그램에 웹 브라우저가 처음 접속할 때 세션을 생성하고 그 이후로는 이미 생성된 세션을 사용한다.
* request 기본 객체가 하나의 요청을 처리하는데 사용되는 JSP 페이지 사이에서 공유된다면, 세션 기본 객체는 웹 브라우저의 여러 요청을 처리하는 JSP 페이지 사이에서 공유된다.

### 세션 생성
* 사용자가 HTTP 요청의 바디에 인증 정보를 실어 서버로 보낸다.
* 서버에서는 해당 인증 정보가 유효하면 사용자의 데이터를 식별하는 Session ID를 생성한다. 
* 서버는 생성된 Session ID를 응답의 Set-Cookie 헤더에 실어 보낸다.

### 세션 사용
* 클라이언트는 해당 세션 아이디를 쿠키에 저장하고, 매 요청마다 세션 아이디를 Cookie 헤더에 실어 전송한다. 
* 서버는 전달받은 세션 아이디를 통해 해당 요청의 송신자가 누구인지 식별한다.
```
[참고]
세션 아이디에 대한 쿠키의 키는 세션을 관리하는 주체에 따라 다르다.
톰캣은 JSESSIONID 라는 이름으로 세션 아이디를 저장하고, node.js는 connect.sid 라는 이름으로 저장한다고 한다.
```

## 세션 저장
* 일반적으로 생성된 세션 데이터는 서버의 메모리에 저장된다.
* 하지만 Scale Out(수평 확장)하여 서버가 여러대인 경우 세션 불일치라는 문제가 발생한다.
* 더 자세한 내용은 [세션 불일치와 해결방법](./session_in_distributed_server.md) 참고

## 세션 구성
* 세션 ID
	- 각 세션을 구분하기 위해 세션마다 고유 ID 할당
	- 웹 브라우저는 웹 서버에 연결할 때마다 매번 세션 ID를 보내서 웹 서버가 어떤 세션을 사용할지 판단할 수 있게 한다.
	- 쿠키를 통해 세션 ID 공유
* 세션 생성 시간
* 마지막 세션 접근 시간
	- 웹 브라우저가 가장 마지막에 세션에 접근한 시간 |
* 세션 유효 시간 
	- 세션의 마지막 접근 이후 일정 시간 이내에 다시 세션을 접근하지 않는 경우 자동으로 세션 종료
	- 유효 시간이 없는 상태에서 세션을 종료시키지 않으면 세션 객체가 매모리에 남게 되어 메모리 부족 현상이 발생한다.

## 세션과 로그인
- 유저가 로그인을 하면 서버 메모리 상에 세션이 저장된다. 세션 구분을 위해 세션 ID를 기준으로 정보를 저장한다.
- 웹 브라우저에 쿠키로 세션 ID가 저장된다.
- 웹 브라우저는 모든 리퀘스트에 세션 ID를 쿠키에 담아 서버로 전송한다.
- 서버는 웹 브라우저가 보낸 세션 ID와 서버 메모리에서 관리하고 있는 세션 ID를 비교해서 로그인 여부를 판단한다.
- 서버에 저장하기 때문에 안전하다.
- 서버에서 클라이언트 상태를 모두 유지하고 있어야 해서 메모리나 데이터베이스의 부하가 심하다.
- 사용자가 많아지는 경우 로드 밸런싱을 사용한 서버 확장을 해야되는데 이때 세션 관리가 어려워진다.

____________________________________________
# 쿠키와 세션의 차이점
* 쿠키는 웹 브라우저에도 저장될 수 있지만 세션은 서버에만 저장될 수 있다. 쿠키가 클라이언트 측의 데이터 보관소라면 세션은 서버 측의 데이터 보관소
* 세션이 쿠키보다 보안에 앞선다.
	* 쿠키의 이름이나 데이터는 네트워크를 통해 전달되기 때문에 HTTP 프로토콜을 사용하는 경우 중간에 누군가가 쿠키의 값을 읽어올 수 있다.
* 웹 브라우저가 쿠키를 지원하지 않거나 강제적으로 쿠키를 막는 경우, 쿠키는 사용할 수 없지만 세션은 쿠키 설정 여부에 상관없이 사용할 수 있다.
* 세션은 여러 서버에서 공유할 수 없지만, 쿠키는 도메인을 이용해서 쿠키를 여러 도메인 주소에 공유할 수 있다.

## 참고자료
* https://hudi.blog/cookie-and-session/
* 쿠키의 보안
	https://velog.io/@sweet_sumin/%EC%BF%A0%ED%82%A4%EC%97%90-%EB%B3%B4%EC%95%88-%EC%A0%95%EB%B3%B4%EB%A5%BC-%EC%A0%80%EC%9E%A5%ED%95%B4%EB%8F%84-%EB%90%98%EB%8A%94%EA%B0%80
* 세션 쿠키 https://stackoverflow.com/questions/34870747/session-cookie-vs-persistent-cookie
