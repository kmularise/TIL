# 세션 불일치를 해결하는 방법

## Scale Out VS Scale Up
![image](https://github.com/kmularise/TIL/assets/106499310/b60967d8-7ac4-40c3-abcc-59dd119a028b)
* Scale-Up : 서버의 스펙을 늘리는 방식 (서버의 메모리카드나 CPU 부품을 업그레이드하여 부하를 최소화)
* Scale-Out : 서버의 개수를 늘리는 방식 (여러 대의 서버를 두어 부하 분산)
    * 로드밸런싱 : 여러 대의 서버를 두고 트래픽을 분산처리하여 서버의 부하량 증가, 속도 저하 등을 해결

## 세션 불일치
* 서버가 여러 대인 상황에서 세션을 식별하지 못하는 문제
* 유저의 세션 정보가 저장되지 않은 서버에 유저의 요청이 도달했을 때, 유저의 요청이 제대로 처리되지 않은 상황
* 서버 별로 저장된 세션 정보가 다르기 때문에 데이터 정합성이 깨지는 상황

## 세션 불일치를 해결하는 방법
### 1. Sticky Session
![image](https://github.com/kmularise/TIL/assets/106499310/f0854829-a357-47ed-84c9-df4bf97ef147)

* 클라이언트의 요청이 항상 해당 클라이언트의 세션이 저장된 서버로 향하는 방식
* 세션 정보가 없는 유저가 요청을 한 경우 로드 밸런서 기본 알고리즘대로 요청을 전달, 이때 이 요청으로 인해 세션이 생성된 경우 해당 유저의 요청은 해당 서버로 고정
* 요청을 특정 서버로 고정시키는 방법 : 쿠키를 통해 판단, 클라이언트의 IP를 확인하여 판단

[문제점]

1. 특정 서버에 트래픽이 집중될 가능성이 있음
    * 로드 밸런서는 여러 서버에 요청을 적절히 분산해서 부하가 특정 서버에 몰리지 않기 위해 사용하는데, Sticky Session을 이용하면 특정 서버에 부하가 몰리게 될 수 있어 로드 밸런싱 원래 목적을 달성할 수 없다.
2. 서버 중 하나에 장애가 발생하면, 해당 서버가 들고 있던 세션 정보는 모두 유실되어 해당 서버에 고정된 유저는 다시 로그인해야 하는 문제점을 가지고 있다. 즉, 가용성 문제가 있다.

### 2. Session Clustering / Session Replication
![image](https://github.com/kmularise/TIL/assets/106499310/673b81ce-6950-4017-8512-b42eb81e0c9d)

* Session Clustering 방식은 특정 서버에서 세션이 생성될 때 다른 서버로 세션을 전파하여 복제하는 방식
* 특정 서버에 부하가 집중되는 문제와, 가용성 문제를 해결할 수 있다.

[문제점]

1. 비효율적인 메모리 관리
    * 세션을 모든 서버가 복제하여 들고있기에 메모리를 낭비하게 된다.
2. 세션을 생성할 때마다 데이터를 전파하고 복제하는 과정에서 Sticky Session 방식에 비해 많은 네트워크 트래픽 사용
3. 세션을 전파하고 복제하는 과정에서 시간차로 인하여 세션 불일치가 발생할 가능성이 있다.

### 3. 세션 스토리지 분리
![image](https://github.com/kmularise/TIL/assets/106499310/25c25952-a350-42a8-85ab-0e9ce82f7d51)

* 세션 스토리지를 외부 서버로 분리하는 방식
    * 세션 정보는 영속성을 보장할 필요가 없기에, 입출력이 잦은 세션 특성 상 I/O 성능이 느린 Disk-Based DB 보다 In-Memory DB(Redis)를 사용하는 것이 일반적이다. 
* 특정 서버에 부하가 집중되는 문제, 가용성 문제, 비효율적인 메모리 관리, 네트워크 트래픽 증가 문제, 시간차로 인한 세션 불일치 문제를 해결할 수 있다.

[문제점]

* 세션 스토리지가 하나라면 스토리지에 장애가 발생할 때 모든 서버가 세션 데이터를 사용할 수 없게 된다.
* 세션 스토리지를 여러개로 구성하는 방식으로 해결할 수 있다.

## 용어
1. 가용성 : 서버와 네트워크 또는 프로그램 등의 다양한 정보 시스템을 정상적으로 사용 가능한 정도
2. 고가용성 : 서버와 네트워크 또는 프로그램 등의 정보 시스템이 상당히 오랜 기간 동안 지속적으로 장애 없이 정상 운영이 가능한 성질

## 참고자료
* 세션 불일치
    * https://hudi.blog/session-consistency-issue/
    * https://daakludens.github.io/project/session/
    * https://liasn.tistory.com/3
* 가용성
https://www.stevenjlee.net/2020/06/28/%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-%EA%B0%80%EC%9A%A9%EC%84%B1-availability-%EA%B3%BC-%EA%B3%A0%EA%B0%80%EC%9A%A9%EC%84%B1-high-availability/
