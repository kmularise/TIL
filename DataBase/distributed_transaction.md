# 분산 트랜잭션
* 네트워크에 존재하는 2개 그 이상의 시스템 사이에서 발생하는 트랜잭션이다.
* 일반적으로 서버들은 트랜잭션 리소스를 제공하고 트랜잭션 관리자는 리소스에 대한 모든 작업을 포함하는 전역 트랜잭션을 만들고 관리한다.
* 분산 트랜잭션에 참여한 각 서비스들은 각자 로컬 트랜잭션을 수행한다.

## 2-phase commit
* 여러 개 데이터베이스를 사용하는 분산 트랜잭션 환경에서 데이터 일관성을 보장하기 위한 방법
* 2단계 커밋에는 트랜잭션을 관리하는 별도의 코디네이터(coordinator)가 존재한다. 코디네이터에 의해 2단계에 걸쳐 트랜잭션을 처리한다.

### First Phase(Prepare Phase)
* 코디네이터는 각 데이터베이스 노드들에게 커밋을 위한 준비 요청을 보낸다.
* 각 데이터베이스 노드들은 준비 성공, 실패 여부를 응답한다.

### Second Phase(Commit Phase)
* 코디네이터는 모든 데이터베이스 노드들로부터 준비 완료 응답을 받으면 커밋을 요청한다.
* 코디네이터는 단 하나의 데이터베이스 노드라도 준비 실패 응답을 보내면 모든 데이터베이스 노드들에게 롤백을 요청한다.

### 2-phase commit의 단점
* 트랜잭션 책임이 코디네이터에게 집중되어 있다.
    * 시스템 실패 포인트가 하나에 집중되어 있어서 코디네이터에 이상이 발생하는 경우 시스템이 중단된다.
    * 코디네이터와 많은 통신이 발생하기 때문에 속도가 느리다.
* 시스템의 전반적인 속도가 가장 느린 데이터베이스 노드에 맞춰진다.
* NoSQL 데이터베이스는 2단계 커밋을 지원하지 않는다.


## Saga 패턴
* 분산 트랜잭션 환경에서 강력한 데이터 일관성을 지키지 못하는 한계를 인정하고 최종적인 일관성(eventually consistency)을 보장하기 위한 방법
## Sage 패턴 흐름
비즈니스 흐름을 따라 서비스들의 로컬 트랜잭션을 순차적으로 처리

1. 전체적인 비즈니스 프로세스를 살펴보고 각 서비스의 로컬 트랜잭션으로 처리할 수 있도록 작업 단위를 나누고 순서를 결정한다.
2. 선행되어야 하는 서비스부터 로컬 트랜잭션을 처리한다.
3. 로컬 트랜잭션을 마친 서비스는 다음 트랜잭션이 수행되도록 트리거(trigger)시킨다.
    * 트리거 방법은 이벤트나 메시징 방식
4. 비즈니스 프로세스를 따라 각 서비스들에서 로컬 트랜잭션이 실행된다.

##  보상 트랜잭션(Compensate Transaction)
* 각 서비스는 로컬 트랜잭션을 커밋하기 때문에 다음 서비스가 실패할 경우 자신의 상태를 이전으로 되돌려야 한다. 로컬 트랜잭션이 끝났으므로 롤백(rollback)은 불가하지만, 비즈니스적인 의미에서 이전 상태로 되돌린다.(undo). 
* 개발자는 보상 트랜잭션을 위한 고려사항들을 설계에 반영하고 별도 로직을 구현해야 한다.

### choreography-based pattern


### 오케스트레이션 사가(Orchestration Saga)
* 전체적인 트랜잭션을 조율하는 컴포넌트가 존재한다.

1. 해당 비즈니스를 처리하기 위한 사가 컴포넌트가 전체 트랜잭션을 컨트롤한다.
2. 사가 컴포넌트는 자신이 책임지고 있는 로직을 수행하고 다음 참가자에게 메세지를 전달한다.
3. 다른 사가 패턴 참가자의 메세지 응답에 따라 필요한 다음 처리를 선택적으로 수행한다. 
4. 사가 패턴에 참여하는 서비스들은 다른 참가자들을 알 필요가 없다.

<!-- https://junhyunny.github.io/msa/design-pattern/distributed-transaction/ -->

### 코리오그래피 사가(Choreography Saga)
* 각자의 책임을 스스로 수행한다. 책임을 사가 패턴 참가자들에게 분산한다.

1. 사가 패턴에 참여하는 서비스들은 자신이 책임진 로직을 수행하고, 자신이 업무를 마쳤음을 다음 참가자를 위해 이벤트로 발행한다. 
2. 사가 패턴 참여자들은 관심있는 이벤트를 구독하고, 이벤트 수신 시 필요한 로직을 수행한다. 
3. 만약, 참가자가 정상적으로 로직을 수행하지 못했다면 보상 트랜잭션을 위한 이벤트를 발행한다. 
4. 보상 트랜잭션 관련된 이벤트를 구독하는 서비스들은 이벤트 수신 시 필요한 보상 로직을 수행합니다.
